# 前端日志监控

嗯，又是前端一个深入细分领域，说简单也简单，说复杂也能做得很复杂。



简而言之，我们需要通过各种手段收集客户端的页面报错信息，更好地帮助我们快速定位线上应用问题。



## 常见日志有哪些

前端页面常见的日志有哪些类型呢？

报错类：

* 接口请求报错，一般指的是 ajax
* 全局脚本报错
* 业务代码报错

统计类：

* 接口耗时
* 渲染耗时
* 性能指标
* 访问统计 PV/UV



## 日志记录原则

### 可靠性

可靠性指的是日志的行为应该不影响我们业务逻辑代码的执行，最好是不占用其运行时间片。

有几种方式可以有效做到这一点

* **navigator.sendBeacon()**
* **window.requestIdleCallback()**

另外一个就是，较好的兼容性，所以在日志框架内应该做好准确的判断和兼容性。

### 稳定性

稳定性指的是日志行为应该是稳定的，在出现意外情况下也能保证日志准确无误地上传到服务器。

譬如，如果用户关闭了页面，我们还有的日志没有上传到服务器怎么办？

用户刷新页面时，如何处理日志丢失的问题？

> 一般可以通过监听 `unload` 或者 `beforeunload` 事件，在页面跳转或者关闭时发起一个 **同步** 请求，
>
> 但这种方式体验比较差，会影响新页面的加载。



## 日志上传方式

一般前端的日志记录对应着后端的一个日志服务器用户存储记录，并且提供日志可视化服务。



选择什么上传方式？

> 同域服务器，一般选择 ajax 异步上传的方式。
>
> 跨域服务器，一般选择 jsonp 或者 通过 img 的 src 构造请求携带数据上传。



什么时候开始记录？

> 应开始于任何业务代码和接口执行之前。



应该记录哪些信息？

> 一般通用的信息有：
>
> * **appId** 应用 ID 标识，一般是应用名称或者网站地址
> * **userId** 用户 ID
> * **type** 日志类型，例如错误、警告、统计
> * **time** 日志发生时间，一般自动生成
> * **title** 日志标题，日志情况的简述
> * **from** 具体日志来源，例如接口、全局错误
> * **data** 具体的日志数据，一般是 JSON，不限格式





#### 参考

1. 《如何用网页追踪用户》<http://www.ruanyifeng.com/blog/2019/04/user-tracking.html>