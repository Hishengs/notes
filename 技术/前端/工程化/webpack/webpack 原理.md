## webpack 构建流程

- 初始化
- 编译
- 输出

如果使用了 webpack-dev-server，文件改变时，编译和输出步骤会反复被执行。



### 初始化

| 事件名            | 解释                                                         |
| :---------------- | :----------------------------------------------------------- |
| 初始化参数        | 从配置文件和 Shell 语句中读取与合并参数，得出最终的参数。 这个过程中还会执行配置文件中的插件实例化语句 `new Plugin()`。 |
| 实例化 `Compiler` | 用上一步得到的参数初始化 `Compiler` 实例，`Compiler` 负责文件监听和启动编译。`Compiler` 实例中包含了完整的 `Webpack` 配置，全局只有一个 `Compiler` 实例。 |
| 加载插件          | 依次调用插件的 `apply` 方法，让插件可以监听后续的所有事件节点。同时给插件传入 `compiler` 实例的引用，以方便插件通过 `compiler` 调用 Webpack 提供的 API。 |
| `environment`     | 开始应用 Node.js 风格的文件系统到 compiler 对象，以方便后续的文件寻找和读取。 |
| `entry-option`    | 读取配置的 `Entrys`，为每个 `Entry` 实例化一个对应的 `EntryPlugin`，为后面该 `Entry` 的递归解析工作做准备。 |
| `after-plugins`   | 调用完所有内置的和配置的插件的 `apply` 方法。                |
| `after-resolvers` | 根据配置初始化完 `resolver`，`resolver` 负责在文件系统中寻找 |



### 编译

| `run`           | 启动一次新的编译。                                           |
| --------------- | ------------------------------------------------------------ |
| `watch-run`     | 和 `run` 类似，区别在于它是在监听模式下启动的编译，在这个事件中可以获取到是哪些文件发生了变化导致重新启动一次新的编译。 |
| `compile`       | 该事件是为了告诉插件一次新的编译将要启动，同时会给插件带上 `compiler` 对象。 |
| `compilation`   | 当 `Webpack` 以开发模式运行时，每当检测到文件变化，一次新的 `Compilation` 将被创建。一个 `Compilation` 对象包含了当前的模块资源、编译生成资源、变化的文件等。`Compilation` 对象也提供了很多事件回调供插件做扩展。 |
| `make`          | 一个新的 `Compilation` 创建完毕，即将从 `Entry` 开始读取文件，根据文件类型和配置的 `Loader` 对文件进行编译，编译完后再找出该文件依赖的文件，递归的编译和解析。 |
| `after-compile` | 一次 `Compilation` 执行完成。                                |
| `invalid`       | 当遇到文件不存在、文件编译错误等异常时会触发该事件，该事件不会导致 Webpack 退出。 |



### 输出

| 事件名        | 解释                                                         |
| :------------ | :----------------------------------------------------------- |
| `should-emit` | 所有需要输出的文件已经生成好，询问插件哪些文件需要输出，哪些不需要。 |
| `emit`        | 确定好要输出哪些文件后，执行文件输出，可以在这里获取和修改输出内容。 |
| `after-emit`  | 文件输出完毕。                                               |
| `done`        | 成功完成一次完成的编译和输出流程。                           |
| `failed`      | 如果在编译和输出流程中遇到异常导致 Webpack 退出时，就会直接跳转到本步骤，插件可以在本事件中获取到具体的错误原因。 |