建议拜读：[The Node.js Event Loop, Timers, and `process.nextTick()`](<https://nodejs.org/en/docs/guides/event-loop-timers-and-nexttick/>)



众所周知，JavaScript 是一门单线程的语言，然而，单线程并不是指 JavaScript 只有一条线程，而是 JavaScript 引擎执行代码只有一条线程，称之为主线程，在主线程上，除了执行脚本代码外，还负责操作 DOM ，绘制 UI 等，因此，当代码执行耗时较长时，界面会出现卡顿的现象。



除了主线程之外，其实还存在其他辅助线程，例如，任务队列线程（每一类任务一条线程），事件循环线程等等。



因此，了解 JavaScript 线程之间的关系以及如何协作是很有必要的。



在程序中，任务可以分为同步任务和异步任务，同步任务指的是，必须等待当前任务执行完毕，后续任务才可以执行，因为所有的同步代码和任务都在同一条线程上排队等待被执行的。



然而，如果引擎遇到了一个异步任务，并不会等待该任务执行完毕，而是接着执行下一个同步任务，同时把异步任务的回调加入异步任务队列中去，等主线程的任务都执行完毕时，会通过事件循环的方式到异步任务队列中查询是否有任务已经完成，如果有，取出异步任务回调到主线程中去执行。



JavaScript 中典型的异步任务有：

- 回调函数

  > 例如发起 Ajax 请求时请求成功或者失败时的回调

- 事件回调

  > 例如监听按钮点击事件时的回调

- setTimeout 回调

- setInterval 回调

- Promise

  > Promise 属于微任务，会在本轮循环结束后被执行





JS 的任务队列类型有：

- **timers** 计时器队列（包括 setTimeout, setInterval）
- **pending callbacks** （文件读写等回调）
- **idle, prepare** （内部使用队列）
- **poll**
- **check** （主要是 `setImmediate()` 的回调）
- **close callbacks** （一些关闭事件的回调，例如 `socket.on('close')`）