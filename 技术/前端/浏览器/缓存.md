## 概述

缓存是一种保存资源副本并在下次请求时直接使用该副本的技术。当 web 缓存发现请求的资源已经被存储，它会拦截请求，返回该资源的拷贝，而不会去源服务器重新下载。



## 缓存的分类

- 浏览器缓存
- 代理缓存
- 网管缓存
- CDN 缓存
- 反向代理缓存
- 数据库缓存

根据私有性一般又可分为**私有缓存**和**共享缓存**，例如浏览器缓存就是私有缓存。



## HTTP 的缓存控制

在 HTTP 请求中，一般通过 `Cache-Control` 头部对缓存进行控制。

### 缓存策略


#### 禁止缓存

缓存中不得存储任何关于客户端请求和服务端响应的内容。每次由客户端发起的请求都会下载完整的响应内容。

```html
Cache-Control: no-store
```

#### 强制确认缓存

如下头部定义，此方式下，每次有请求发出时，缓存会将此请求发到服务器（译者注：该请求应该会带有与本地缓存相关的验证字段），服务器端会验证请求中所描述的缓存是否过期，若未过期（注：实际就是返回304），则缓存才使用本地缓存副本。

```html
Cache-Control: no-cache
```

##### 弱校验

通过 `If-Modified-Since` 向服务器询问资源是否过期的方式成为缓存弱校验。

浏览器向服务器请求资源时，服务器的响应中一般携带了资源的最近修改时间头部：`Last-Modified`，当浏览器再次请求该资源时，会通过 `If-Modified-Since` 头部带上该时间向服务器询问自这个时间以来资源是否有发生过更改，如果无，服务器返回 304，则可继续使用本地缓存；否则服务器返回 200，使用返回的最新资源替换旧的缓存。

之所以是弱校验是因为 `Last-Modified` 使用的时间只精确到了秒。

##### 强校验

通过 `If-None-Match` 向服务器询问资源是否过期的方式成为缓存强校验。

如果服务器返回的资源响应中包含了 `ETag` 头部时，浏览器下次请求相同资源时即可通过 `If-None-Match` 头部带上 `ETag` 的值向服务器询问这个资源的 `ETag`  是否发生了变化，若无，服务器返回 304，表示可继续使用本地缓存；否则服务器返回 200，使用返回的最新资源替换旧的缓存。

> **ETag** 类似资源的指纹，一旦目标资源发生了变化，此值也会随之改变。

#### 私有缓存和公共缓存

"public" 指令表示该响应可以被任何中间人（译者注：比如中间代理、CDN等）缓存。若指定了"public"，则一些通常不被中间人缓存的页面（译者注：因为默认是private）（比如 带有HTTP验证信息（帐号密码）的页面 或 某些特定状态码的页面），将会被其缓存。

而 "private" 则表示该响应是专用于某单个用户的，中间人不能缓存此响应，该响应只能应用于浏览器私有缓存中。

```html
Cache-Control: private
Cache-Control: public
```

#### 设置过期时间

一般通过在 `Cache-Control` 头部添加 `max-age=<seconds>` 来设置请求资源缓存在距离此次请求时间多少秒后过期。

```
Cache-Control: max-age=31536000
```

如果在响应中未发现 `max-age` 的设置，则：

1. 查看是否设置了 `Expires` 过期时间，有则以此为缓存过期时间

   > Expires 是 HTTP/1.0 定义的

2. 查看是否存在 `Last-Modified` 头部，如果有，缓存过期时间等于 `Date - Last-Modified ` * 0.1，这种策略称之为 “**启发式缓存**”。

#### 缓存验证确认

当使用了 "`must-revalidate`" 指令，那就意味着缓存在考虑使用一个陈旧的资源时，必须先验证它的状态，已过期的缓存将不被使用。

```html
Cache-Control: must-revalidate
```



## 强缓存与协商缓存

当服务器对某资源的 `Cache-Control` 设置了 `max-age` 或者 `Expires` 头部时，代表该资源需要缓存，且带有缓存时间，这种策略称之为强缓存。

当浏览器再次请求相同资源时，会先判断资源是否过期，如果过期了，就会进入协商缓存阶段，此时浏览器会向服务器询问，此资源是否未更改可以，如果是，继续使用本地缓存并更新过期时间，如果不是，使用服务器返回的最新资源替换掉本地缓存并更新过期时间。

协商缓存一般采用弱校验（`If-Modified-Since`）或者强校验策略（`ETag`）。



## 参考

[1] MDN，[HTTP 缓存](<https://developer.mozilla.org/zh-CN/docs/Web/HTTP/Caching_FAQ>)

[2] Damonare，掘金，[缓存详解](<https://juejin.im/post/5a6c87c46fb9a01ca560b4d7>)