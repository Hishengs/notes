## 建立 TCP 连接

建立 TCP 连接一般是三次握手模式：

![tcpä¸æ¬¡æ¡æ](https://user-gold-cdn.xitu.io/2018/2/5/1616591833b5d408?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

1. 第一次握手

   > 客户端向服务器发送一个 SYN(j) 待确认包，然后等待服务器回包，此时进入 SYN-SENT 状态

2. 第二次握手

   > 服务器收到 SYN(j) 包，向客户端回一个 ACK(j+1) 确认包，表示已接收到，和一个 SYN(k) 待确认包，接着服务器开始等待客户端确认，进入 SYN-RECIVED 状态

3. 第三次握手

   > 客户端接收到服务器的回包，确认服务器已收到消息，此时向服务发送一个 ACK(k+1) 的确认包，告知消息已收到，进入了 ESTABLISHED 状态；此时，双方都已确认过对方的收发是没有问题了，可以建立连接并开始发送消息了



## 断开 TCP 连接

TCP 连接的断开称为“四次挥手”：

![tcpåæ¬¡æ¥æ](https://user-gold-cdn.xitu.io/2018/2/5/1616591831ac99e0?imageView2/0/w/1280/h/960/format/webp/ignore-error/1)

1. 第一次挥手

   > 客户端发送一个 **FIN(M)包**，此时客户端进入 `FIN-WAIT-1` 状态，这表明客户端已经没有数据要发送了

2. 第二次挥手

   > 服务器收到了客户端发来的 FIN(M) 包后，向客户端发回一个 **ACK(M+1) 包**，此时服务器进入 `CLOSE-WAIT` 状态，客户端进入 `FIN-WAIT-2` 状态

3. 第三次挥手

   > 服务器向客户端发送 **FIN(N) 包**，请求关闭连接，同时服务器进入 `LAST-ACK` 状态

4. 第四次挥手

   > 客户端收到服务器发送的 FIN(N) 包，进入 `TIME-WAIT` 状态。向服务器发送 **ACK(N+1)** 包，服务器收到客户端的 ACK(N+1) 包以后，进入 `CLOSE` 状态；客户端等待一段时间还没有得到回复后判断服务器已正式关闭，进入 `CLOSE` 状态





## TCP 滑动窗口

TCP 滑动窗口是客户端与服务器协商报文发送与接收速率的动态调整，如果客户端发送得太快，会导致丢包或者服务器无法及时处理而崩溃；客户端需要根据网络情况和服务器处理能力对报文的发送速率进行调整；如果网络较差，丢包较为严重，则后续的报文都会缓存在一个待发送的队列，这个队列称为滑动窗口；



## 参考

[1] skmj，掘金， [图解 TCP 三次握手与四次分手](<https://juejin.im/post/5a7835a46fb9a063606eb801>)

[2] 老钱，掘金，[跟着动画来学习TCP三次握手和四次挥手](<https://juejin.im/post/5b29d2c4e51d4558b80b1d8c>)